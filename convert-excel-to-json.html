<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel to JSON Converter</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
    <h1 class="text-3xl font-bold text-blue-900 mb-6">Convert Excel to JSON for Part Search</h1>
    
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-3">Instructions:</h2>
      <ol class="list-decimal ml-6 space-y-2 text-gray-700">
        <li>Open your Excel file <strong>IW39 3OCT2025 for Jeff.xlsx</strong></li>
        <li>Save it as CSV: File → Save As → CSV (Comma delimited)</li>
        <li>Upload the CSV file below</li>
        <li>Click "Convert to JSON"</li>
        <li>Download the generated <strong>parts-database.json</strong> file</li>
        <li>Place it in your V2X-Repairs folder</li>
      </ol>
    </div>

    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 mb-4 text-center">
      <input 
        type="file" 
        id="csvFile" 
        accept=".csv"
        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-900 file:text-white hover:file:bg-blue-800"
      >
    </div>

    <button 
      onclick="convertToJSON()" 
      class="w-full bg-blue-900 text-white py-3 rounded-lg font-semibold hover:bg-blue-800 transition"
    >
      Convert to JSON
    </button>

    <div id="output" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-2">Preview:</h3>
      <pre id="jsonPreview" class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
      <button 
        onclick="downloadJSON()" 
        class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition"
      >
        Download parts-database.json
      </button>
    </div>

    <div id="error" class="mt-4 p-4 bg-red-100 text-red-700 rounded-lg hidden"></div>
  </div>

  <script>
    let jsonData = null;

    function convertToJSON() {
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showError('Please select a CSV file first');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').map(line => line.trim()).filter(line => line);
          
          if (lines.length < 2) {
            showError('CSV file appears to be empty or invalid');
            return;
          }

          // Parse CSV headers
          const headers = parseCSVLine(lines[0]);
          
          // Find the columns (case-insensitive)
          const materialIndex = headers.findIndex(h => h.toLowerCase() === 'material');
          const descIndex = headers.findIndex(h => h.toLowerCase().includes('description'));
          
          if (materialIndex === -1 || descIndex === -1) {
            showError('Could not find "Material" or "Material Description" columns. Headers found: ' + headers.join(', '));
            return;
          }

          // Convert to JSON object
          const partsData = {};
          for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length > Math.max(materialIndex, descIndex)) {
              const partNumber = values[materialIndex].trim();
              const description = values[descIndex].trim();
              
              if (partNumber && description) {
                partsData[partNumber] = description;
              }
            }
          }

          jsonData = partsData;
          
          // Display preview
          document.getElementById('jsonPreview').textContent = JSON.stringify(partsData, null, 2);
          document.getElementById('output').classList.remove('hidden');
          document.getElementById('error').classList.add('hidden');
          
          console.log('Converted', Object.keys(partsData).length, 'parts');
          
        } catch (error) {
          showError('Error parsing CSV: ' + error.message);
        }
      };
      
      reader.readAsText(file);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    function downloadJSON() {
      if (!jsonData) {
        showError('No data to download');
        return;
      }

      const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'parts-database.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
  </script>
</body>
</html>

